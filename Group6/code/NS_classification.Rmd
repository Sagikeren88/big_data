---
title: "Business Data analytics Group 6- Show/No Show classification"
output: NS_classi
---

### Import data and set objective
```{r}
#library(knitr)
knitr::opts_knit$set(root.dir = "~/source/big_data/big_data/Group6/datasets")
df.train <- read.csv("../datasets/NS.TRAIN.csv")
df.test <- read.csv("../datasets/NS.TEST.csv")
```
Importing the DF

```{r}
dim(df.train)
table(is.na(df.train))
```
##### Dimantion of the DataFrame and missing values

```{r}
summary(df.train)
```
Display the summarize and define a business target

##### Business question
TBD
##### Predictor columnds explained
* patient_id - 
* appointment - 
* week_day - 
* schedule_date - 
* appointmnet_date -
* waiting_time - 
* age - 
* is_female - 
* scholarship - 
* neighbourhood
* hipertension
* diabetes
* alcoholism
* handcap
* sms_recieved
* no_show
* poverty
* x_coor
* y_coor
* region

##### Evaluation matric of models
 
TBD

### EDA and IDA
##### Numeric and Categorical  
numeric| categorical
------ | --------
X      | country
Price  | designation
points | province
  -    | region_1+2
  -    | variety
  -    | description
  -    | country
  -    | winery

##### which columns have missing values
```{r}
sapply(df.train, function(x) sum(is.na(x)))
```
number of missing values per column

##### which columns to predict
Column to predict is no_show

##### Regression or Classification 
since the Y column is numeric and categorical, the problem is a classification problem

##### Numeric column histograms
```{r}
df = na.omit(df.train)
par(mfrow=c(2,4));
hist(df$week_day, main="week_day", breaks = 10)
hist(log(df$waiting_time+1), main="log waiting_time", breaks = 10)
hist(sqrt(df$age), main="sqrt age", breaks = 10)
hist(df$poverty, main="poverty", breaks = 10)
hist(df$region, main="region", breaks = 10)
hist(log(df$same_day+1), main="same_day", breaks = 10)
hist(log(df$week_before+1), main="week_before", breaks = 10)
hist(log(df$ever_before+1), main="ever_before", breaks = 10)
```
### EDA
```{r}
# looking for no_show frequencies over waiting time
eda_waiting_time<-aggregate(df.train$no_show, by=list(log(df.train$waiting_time+1)), FUN=mean)
names(eda_waiting_time)=c("waiting time","No show prob")
plot(eda_waiting_time, eda_waiting_time$x, type="p", main="No show prob vs. log waiting time")
```
We can identify a group of confident shows around 100 waiting time (days), or 4.5 in log, whereas the majority is around probability of 0.3

```{r}
eda_week_day<-aggregate(df.train$no_show, by=list(df.train$week_day), FUN=mean)
plot(eda_week_day, eda_week_day$x, type="l", main="No show prob vs. week_day")
```
```{r}
eda_age<-aggregate(df.train$no_show, by=list((df.train$age)), FUN=mean)
plot(eda_age, eda_age$x, type="p", main="No show prob vs. age")
```

```{r}
eda_scholarship<-aggregate(df.train$no_show, by=list((df.train$scholarship)), FUN=mean)
plot(eda_scholarship, eda_scholarship$x, type="l", main="No show prob vs. scholarship")
```

```{r}
eda_sms_recieved<-aggregate(df.train$no_show, by=list((df.train$sms_recieved)), FUN=mean)
plot(eda_sms_recieved, eda_sms_recieved$x, type="l", main="No show prob vs. sms_recieved")
```
```{r}
# Low probability - 
par(mfrow=c(2,4))
eda_is_female<-aggregate(df.train$no_show, by=list(df.train$is_female), FUN=mean)
plot(eda_is_female, eda_is_female$x, type="l", main="No show prob vs. is_female", ylim=c(0,1))

eda_poverty<-aggregate(df.train$no_show, by=list((df.train$poverty)), FUN=mean)
plot(eda_poverty, eda_poverty$x, type="l", main="No show prob vs. poverty", ylim=c(0,1))

eda_diabetes<-aggregate(df.train$no_show, by=list((df.train$diabetes)), FUN=mean)
plot(eda_diabetes, eda_diabetes$x, type="l", main="No show prob vs. diabetes", ylim=c(0,1))

eda_hipertension<-aggregate(df.train$no_show, by=list((df.train$hipertension)), FUN=mean)
plot(eda_hipertension, eda_hipertension$x, type="l", main="No show prob vs. hipertension", ylim=c(0,1))

eda_handcap<-aggregate(df.train$no_show, by=list((df.train$handcap)), FUN=mean)
plot(eda_handcap, eda_handcap$x, type="l", main="No show prob vs. handcap", ylim=c(0,1))

eda_same_day<-aggregate(df.train$no_show, by=list((df.train$same_day)), FUN=mean)
plot(eda_same_day, eda_same_day$x, type="l", main="No show prob vs. same_day", ylim=c(0,1))

eda_week_before<-aggregate(df.train$no_show, by=list((df.train$week_before)), FUN=mean)
plot(eda_week_before, eda_week_before$x, type="l", main="No show prob vs. week_before", ylim=c(0,1))

eda_ever_before<-aggregate(df.train$no_show, by=list((df.train$ever_before)), FUN=mean)
plot(eda_ever_before, eda_ever_before1$x, type="l", main="No show prob vs. ever_before", ylim=c(0,1))
     
```

### Modeling
#### LM
```{r}
df.train$log_waiting_time <- log(df.train$waiting_time+1)
logit_all_model <- glm(no_show ~ age+log_waiting_time+scholarship+sms_recieved, data = df.train, family = binomial)
summary (logit_all_model)
plot(logit_all_model)
```


#### CART
```{r}
library("tree")
noshow.CART <- tree(no_show ~ week_day+
                      log(waiting_time+1)+
                      sqrt(age)+
                      is_female+
                      scholarship+
                      hipertension+
                      diabetes+
                      alcoholism+
                      handcap+
                      sms_recieved+
                      poverty+
                      region,data = df.train)
plot(noshow.CART)
text(noshow.CART, pretty = 0, cex=0.5)
summary(noshow.CART)

```

#### RF
```{r}
library("randomForest")
set.seed(7)
noshow.RF <- randomForest(no_show ~ week_day+
                         log_waiting_time+
                         sqrtage+
                         is_female+
                         scholarship+
                         sms_recieved+
                         poverty+
                         region, data = df.train, na.action=na.omit) 
plot(noshow.RF)
noshow.RF
importance(noshow.RF)
varImpPlot(noshow.RF)
```

#### GBM
```{r}
#install.packages("gbm",repos = "http://cran.us.r-project.org")
library("gbm")
set.seed(7) #GBM includes random selection. Repeat same seed to repeat the RF
no_show.gbm <- gbm (no_show ~ week_day+
                         waiting_time+
                         age+
                         is_female+
                         scholarship+
                         sms_recieved+
                         poverty+
                         region,data = df.train, n.trees = 1000, interaction.depth = 4, shrinkage = 0.2, verbose = F) #gbm distribution is gaussian for regression and bernoulli for binary classification
no_show.gbm
summary(no_show.gbm)
```


### Model evaluation
```{r}
# Global threshold decleration
threshold = 0.5
```

#### LM
```{r}
lm_y_est <- predict(lm.model2, df.test)
lm_res <- lm_y_est - df.test$price_log
hist(lm_res)
L1 = sum(abs(lm_res))/length(lm_res)
Res_sq <- lm_res^2
RSS <- sum(Res_sq)
MSE <- RSS/length(Res_sq)
RMSE <- sqrt(MSE)
RMSE
```

#### CART
```{r}
CART.results = predict(Wine.CART, df.test, n.trees = 1000)
summary(CART.results)
CART.prediction = ifelse(CART.results > threshold)
summary(CART.prediction)

Residual <- CART.results - df.test$price_log
Res_sq <- Residual * Residual
RSS <- sum(Res_sq)
MSE <- mean(Res_sq)
RMSE <- sqrt(MSE)
Total_res <- CART.results - mean(df.test$price_log)
TSS <- sum(Total_res*Total_res)
R2 <- 1- RSS/TSS
R2
```

#### RF
```{r}
RF.results = predict(Wine.RF, df.test)
summary(RF.results)
RF.prediction = ifelse(RF.results > threshold,1,0)
summary(RF.prediction)

# CROSS TABLE INSERTION
```

#### GBM
```{r}
GBM.results = predict(Wine.gbm, df.test, n.trees = 1000)
summary(GBM.results)
GBM.prediction = ifelse(GBM.results > threshold,1,0)
summary(GBM.prediction)
```

